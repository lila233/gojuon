name: Build APK

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag for APK filename (optional)'
        required: false
        default: ''

permissions:
  contents: write

concurrency:
  group: build-apk-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Build APK
        id: build
        run: |
          echo "::group::Starting EAS Build"
          # 运行 eas build，将 stderr 重定向到文件以便调试
          eas build --platform android --profile preview --non-interactive --json > build_output.json 2> build_stderr.txt || {
            echo "::error::EAS build command failed"
            cat build_stderr.txt
            cat build_output.json
            exit 1
          }

          # 显示输出用于调试
          echo "Build stderr:"
          cat build_stderr.txt || true
          echo "Build output:"
          cat build_output.json

          # 解析 JSON 获取 build ID
          BUILD_ID=$(jq -r '.[0].id // empty' build_output.json)
          if [ -z "$BUILD_ID" ]; then
            echo "::error::Failed to extract build ID from response"
            exit 1
          fi
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "Build started with ID: $BUILD_ID"
          echo "::endgroup::"

      - name: Wait for build completion
        id: artifact
        run: |
          BUILD_ID="${{ steps.build.outputs.build_id }}"
          echo "Waiting for build $BUILD_ID to complete..."

          MAX_ATTEMPTS=90
          SLEEP_INTERVAL=20

          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "::group::Attempt $i/$MAX_ATTEMPTS"

            # Fetch build info, capture both success and failure
            if ! BUILD_INFO=$(eas build:view "$BUILD_ID" --json --non-interactive 2>/dev/null); then
              echo "eas build:view command failed, retrying..."
              echo "::endgroup::"
              sleep $SLEEP_INTERVAL
              continue
            fi

            # Validate JSON response
            if ! echo "$BUILD_INFO" | jq -e . >/dev/null 2>&1; then
              echo "Invalid JSON response, retrying..."
              echo "::endgroup::"
              sleep $SLEEP_INTERVAL
              continue
            fi

            STATUS=$(echo "$BUILD_INFO" | jq -r '.status // "unknown"' | tr '[:upper:]' '[:lower:]')
            echo "Current status: $STATUS"

            case "$STATUS" in
              "finished")
                BUILD_URL=$(echo "$BUILD_INFO" | jq -r '.artifacts.applicationArchiveUrl // .artifacts.buildUrl // empty')
                if [ -n "$BUILD_URL" ]; then
                  echo "apk_url=$BUILD_URL" >> $GITHUB_OUTPUT
                  echo "✅ Build completed successfully!"
                  echo "::endgroup::"
                  exit 0
                else
                  echo "::error::Build finished but no artifact URL found"
                  exit 1
                fi
                ;;
              "errored"|"canceled")
                echo "::error::Build failed with status: $STATUS"
                echo "::endgroup::"
                exit 1
                ;;
              *)
                echo "Build in progress..."
                ;;
            esac
            echo "::endgroup::"
            sleep $SLEEP_INTERVAL
          done

          echo "::error::Timed out after $((MAX_ATTEMPTS * SLEEP_INTERVAL)) seconds"
          exit 1

      - name: Determine APK filename
        id: filename
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          elif [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="dev-$(date +%Y%m%d-%H%M%S)"
          fi
          FILENAME="gojuon-${VERSION}-universal.apk"
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "APK will be saved as: $FILENAME"

      - name: Download APK
        run: |
          echo "Downloading APK from EAS..."
          curl -L --fail --retry 3 -o "${{ steps.filename.outputs.filename }}" "${{ steps.artifact.outputs.apk_url }}"
          ls -lh "${{ steps.filename.outputs.filename }}"

      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.filename.outputs.filename }}
          path: ${{ steps.filename.outputs.filename }}
          retention-days: 30

      - name: Upload APK to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.filename.outputs.filename }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| APK Filename | \`${{ steps.filename.outputs.filename }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Build ID | \`${{ steps.build.outputs.build_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "| Release | ${{ github.event.release.tag_name }} |" >> $GITHUB_STEP_SUMMARY
          fi
